---
- name: Deploy echo-server Helm chart
  hosts: node1
  become: yes
  vars_files:
    - vault.yml
  vars:
    kube_pwd: "/home/{{ ansible_user | default('user') }}/.kube"
  tasks:
    - name: Copy echo-server-chart directory to node1
      copy:
        src: ./echo-server-chart/
        dest: /tmp/echo-server-chart
        mode: preserve

    - name: Ensure echo-server namespace exists
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: echo-server
        state: present
        kubeconfig: "{{ kube_pwd }}/config"

    - name: Ensure docker-registry secret exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: regcred
            namespace: echo-server
          type: kubernetes.io/dockerconfigjson
          data:
            .dockerconfigjson: "{{ {'auths': {'https://index.docker.io/v1/': {'username': username, 'password': passwd, 'email': email, 'auth': (username + ':' + passwd)|b64encode }}} | to_nice_json | b64encode }}"  
        kubeconfig: "{{ kube_pwd }}/config"
      no_log: true

    - name: Label echo-server namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: echo-server
        definition:
          metadata:
            labels:
              app.kubernetes.io/managed-by: Helm
        state: present
        kubeconfig: "{{ kube_pwd }}/config"

    - name: Annotate echo-server namespace with release name
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: echo-server
        definition:
          metadata:
            annotations:
              meta.helm.sh/release-name: echo-server
              meta.helm.sh/release-namespace: echo-server
        state: present
        kubeconfig: "{{ kube_pwd }}/config"

    - name: Install echo-server Helm chart
      kubernetes.core.helm:
        name: echo-server
        chart_ref: /tmp/echo-server-chart/
        release_namespace: echo-server
        state: present
        kubeconfig: "{{ kube_pwd }}/config"
        
